<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Functional Children拗らせてたトイプロダクトをReact hooksとContext使って書き換えた感想</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Functional Children拗らせてたトイプロダクトをReact hooksとContext使って書き換えた感想</h1>
</header>
<section data-field="subtitle" class="p-summary">
React 16.8で有効となったReact Hooks。魅力的な点は多々あるが、個人的に気になっていたのがState管理部分。
</section>
<section data-field="body" class="e-content">
<section name="762c" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--fullWidth"><figure name="c251" id="c251" class="graf graf--figure graf--layoutFillWidth graf--leading"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 29.2%;"></div><img class="graf-image" data-image-id="1*6XqrwnJC_gSIYmysAHpM4Q.png" data-width="3974" data-height="1159" src="https://cdn-images-1.medium.com/max/2560/1*6XqrwnJC_gSIYmysAHpM4Q.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><h3 name="661b" id="661b" class="graf graf--h3 graf-after--figure graf--title">React Hooksが出たのでFunctiona as ChildrenこじらせてたトイプロダクトをReact hooksとContextで書き換えた話</h3><p name="cfb8" id="cfb8" class="graf graf--p graf-after--h3">React 16.8で有効となったReact Hooks。魅力的な点は多々あるが、個人的に気になっていたのがState管理部分。</p><p name="acb6" id="acb6" class="graf graf--p graf-after--p">ReduxのStateの単一管理とはまた違っていて複数のState、Contextを使うような感じになってくる。<br>ただやはり単一Stateの管理はそれはそれで良い点を感じていて、「いやいやuseState本当にぐちゃぐちゃにならないのか？」という疑問があったりもした。</p><p name="3260" id="3260" class="graf graf--p graf-after--p">このあたりを検証したいなーと思っていたところ、以前<a href="https://medium.com/@terrierscript/dart-sass-de-asobou-9def3bbd8e28" data-href="https://medium.com/@terrierscript/dart-sass-de-asobou-9def3bbd8e28" class="markup--anchor markup--p-anchor" target="_blank">Dart Sassをブラウザで動かした</a>ときに作った<a href="https://dart-sass-bootstrap-demo.netlify.com/" data-href="https://dart-sass-bootstrap-demo.netlify.com/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">トイプロダクト</a>がコードがStateを複数持たせたりして「うわーっ！爆発するー！」ってなってたことを思い出して書き換えをやってみたのでその雑感などをまとめたい。</p><p name="8e06" id="8e06" class="graf graf--p graf-after--p">今回の主題はトイプロダクトだからやったことなので、「さあ今すぐみんなHooksだ！」という趣旨のものではない（多分そういうのは推奨されてない）</p><p name="eba5" id="eba5" class="graf graf--p graf-after--p">書き換えた差分はこちら。（コミットメッセージが雑なのは・・・ほら・・・トイプロダクトだから・・・みたいなところで勘弁してほしい）</p><div name="87e8" id="87e8" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://github.com/terrierscript/dartystrap/compare/902ed8e...2b5c0a2f#files_bucket" data-href="https://github.com/terrierscript/dartystrap/compare/902ed8e...2b5c0a2f#files_bucket" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://github.com/terrierscript/dartystrap/compare/902ed8e...2b5c0a2f#files_bucket"><strong class="markup--strong markup--mixtapeEmbed-strong">terrierscript/dartystrap</strong><br><em class="markup--em markup--mixtapeEmbed-em">Contribute to terrierscript/dartystrap development by creating an account on GitHub.</em>github.com</a><a href="https://github.com/terrierscript/dartystrap/compare/902ed8e...2b5c0a2f#files_bucket" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="a1e2e082b9ccbdcd7a4f0be6d5a18b86" data-thumbnail-img-id="0*fewFkp6DlMAhOpay" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*fewFkp6DlMAhOpay);"></a></div><h3 name="f97b" id="f97b" class="graf graf--h3 graf-after--mixtapeEmbed">元のコードの問題点</h3><p name="65cb" id="65cb" class="graf graf--p graf-after--h3">今回対象としたプロダクトは「Dart Sassをブラウザ上で動かしてbootstrap4をコンパイルする」というものだった。<br>主題としてはDartの部分なので、表側のUIやらは「まあこのへんはReactでいいだろう。たいして複雑な状態管理もしない飽きたしReduxもいらんいらん！」という感じで進めていたと記憶している。<br>一方でバケツリレーもしんどいもんな〜というところがあったりで<a href="https://qiita.com/terrierscript/items/03df4d522cf9cf431021" data-href="https://qiita.com/terrierscript/items/03df4d522cf9cf431021" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">当時ハマってたFunction as Children</a>を使いまくっていたのもカオスを増す結果を作っているなと読み返して感じた部分だった。</p><p name="4c3e" id="4c3e" class="graf graf--p graf-after--p">状態管理自体がそこまで複雑で無いとは言え、Sassを非同期にコンパイル処理してその結果を保持して・・・みたいな処理もあったりしてそこそこ複雑な処理になっていた。</p><p name="b946" id="b946" class="graf graf--p graf-after--p">まず要件としてはこんな具合を叶えたいものがこのへん</p><ul class="postList"><li name="8547" id="8547" class="graf graf--li graf-after--p">Bootstrapのカスタムする変数部分をいじりたい</li><li name="b0b1" id="b0b1" class="graf graf--li graf-after--li">いじった値をコンパイラに渡してコンパイルさせたい</li><li name="52d2" id="52d2" class="graf graf--li graf-after--li">コンパイルは遅いので初回(componentDidMountのタイミング）だけコンパイルさせ、それ以降はボタンを押すことでコンパイルさせたい</li><li name="ca96" id="ca96" class="graf graf--li graf-after--li">再度コンパイルされる時に前回のworkerを止めたい</li></ul><p name="a260" id="a260" class="graf graf--p graf-after--li">上記の要件を踏まえ、だいたいこんな具合になっていた</p><ol class="postList"><li name="029b" id="029b" class="graf graf--li graf-after--p">変数をVariableContextとしてコンテキストにする</li><li name="6c9a" id="6c9a" class="graf graf--li graf-after--li">Submitterという中間コンポーネントを使い、VariableContextから値をもらってPropsに変換して初回だけCompilerに渡し、その後はビルドボタンを押した時のみCompilerへ渡すみたいなものを</li><li name="682b" id="682b" class="graf graf--li graf-after--li">CompilerはPropsとしてPropsが変わったらコンパイルするシンプルなものにする</li></ol><p name="637d" id="637d" class="graf graf--p graf-after--li">という形を作った。雑に簡略化するとこんな具合になる。</p><pre name="62de" id="62de" class="graf graf--pre graf-after--p">&lt;VariableContext.Consumer&gt;{ (variables) =&gt; {<br>  &lt;Submitter value={variables}&gt;{(value, submit) =&gt; { // submitするとvariablesがvalueに反映されるみたいなやつ<br>    &lt;button onClick={() =&gt; submit()}&gt;Generate&lt;/button&gt;     <br>    &lt;Compiler variables={value}&gt;({(css) =&gt; {<br>       ...</pre><p name="2307" id="2307" class="graf graf--p graf-after--pre">コンパイラの代わりにフィボナッチ関数で簡略化したのも置いておく（これを書いてる時にinitialValueみたいなものをCompilerに持たせればSubmitterなんて複雑なものいらないじゃんということに気付いて修行不足を感じたがこの件は割愛する）</p><figure name="c727" id="c727" class="graf graf--figure graf--iframe graf-after--p"><blockquote class="twitter-tweet"><a href="https://twitter.com/terrierscript/status/1093122075785453568?s=20"></a></blockquote><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></figure><div name="c976" id="c976" class="graf graf--mixtapeEmbed graf-after--figure"><a href="https://codesandbox.io/embed/w7zmy1ymol?autoresize=1&amp;initialpath=src%2F" data-href="https://codesandbox.io/embed/w7zmy1ymol?autoresize=1&amp;initialpath=src%2F" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://codesandbox.io/embed/w7zmy1ymol?autoresize=1&amp;initialpath=src%2F"><strong class="markup--strong markup--mixtapeEmbed-strong">Fibonacci-Function-as-children - CodeSandbox</strong><br><em class="markup--em markup--mixtapeEmbed-em">CodeSandbox is an online editor tailored for web applications.</em>codesandbox.io</a><a href="https://codesandbox.io/embed/w7zmy1ymol?autoresize=1&amp;initialpath=src%2F" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="c4d2427a5fd8a45aa888df8cdc37e706"></a></div><h3 name="a0d8" id="a0d8" class="graf graf--h3 graf-after--mixtapeEmbed">本題：React Hooksにするとどうなったか？</h3><h4 name="12ab" id="12ab" class="graf graf--h4 graf-after--h3">やはりuseEffectが非常に便利</h4><p name="ce9b" id="ce9b" class="graf graf--p graf-after--h4">上記のコンパイル部分についてだが、Class Componentでは<a href="https://github.com/facebook/react/issues/12397#issuecomment-375501574" data-href="https://github.com/facebook/react/issues/12397#issuecomment-375501574" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">contextをcomponentDidMountで呼び出すことは推奨されてない</a>ことも複雑さの一端を担っていたと言える。</p><p name="2da5" id="2da5" class="graf graf--p graf-after--p">これがuseEffectによってかなりすっきり書けたると感じた</p><figure name="b74e" id="b74e" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/terrierscript/635d2094f512b66cc6cbe48c6a56cb7a#file-usecompile-ts.js"></script></figure><p name="d3f8" id="d3f8" class="graf graf--p graf-after--figure">正直なことを言うと、「ホントに？ホントにuseContextとuseEffect組み合わせて大丈夫・・・？」みたいな心配はちょっとだけあるけどrenderに相当するタイミングでhooksに入るはずなので多分大丈夫だと思う・・・</p><h4 name="81f4" id="81f4" class="graf graf--h4 graf-after--p">細かくStateを分離するのは良さそう</h4><p name="f876" id="f876" class="graf graf--p graf-after--h4">Reduxを使わないとはいえ、これまでのReact ComponentではClass Componentを使いたくないなどがあって不必要にstateが肥大化して、同時にそれに絡むハンドラーなんかも太くなる傾向があった。これはそれぞれのstateとハンドラーを useXxxx とまとめることでいくらか可読性を担保できると感じた。</p><p name="6a31" id="6a31" class="graf graf--p graf-after--p">例えば今回「コンパイラをworkerで動かすかどうか」というチェックボックスの状態を分離して、これはこれでいいかもなと思った。</p><figure name="9e8f" id="9e8f" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/terrierscript/7b6363458c25f3bba35d77a034d61b6e.js"></script></figure><h4 name="8af0" id="8af0" class="graf graf--h4 graf-after--figure">不用意なHoCsやFunction as Childrenがなくなる</h4><p name="62c1" id="62c1" class="graf graf--p graf-after--h4">「コンポーネントだけで構成される」というReactの世界においてFunction as ChildrenやHoCsの発明は確かに有益なものだったが、HoCsの型周りの面倒さやどうしても可読性が下がる点があったり、Function as Childrenはコンポーネントなのに主体が関数であるみたいな読み応えとして不可解になるケースも少なくなかった。</p><p name="6c64" id="6c64" class="graf graf--p graf-after--p">Hooksが入ることで実は一番縁遠くなるのはこの辺になるだろうと感じた。もし最初にHooksを導入するなら「なんだかこのへんシッチャカメッチャカなんだよな」というHoCsやFunction as Childrenを標的にしてみるといいかもしれない</p><h4 name="b083" id="b083" class="graf graf--h4 graf-after--p">コンポーネントは小さく。SmartなコンポーネントとPresentationalなコンポーネントを分けるという原則は相変わらず有益</h4><p name="45d5" id="45d5" class="graf graf--p graf-after--h4">Hooksが入っても変わらないだろうなと思ったことがこれだ。やはり書き換えてる最中にコンポーネントが小さければ小さいほど書き換えやすいなと感じたし、stateなど状態を気にするコンポーネントとそうでないコンポーネントがきっちり別れていない部分ほど手こずるなと感じた。</p><p name="f497" id="f497" class="graf graf--p graf-after--p">hooksが入ってしまうことで行数的には縮んでしまったり逆にstateなどライトに使えてしまう側面があるが、ここは気を引き締めてとにかく分離してくように心がけたほうが良いなと感じた</p><h4 name="175e" id="175e" class="graf graf--h4 graf-after--p">Contextの扱いは考えものかも？</h4><p name="9108" id="9108" class="graf graf--p graf-after--h4">Stateをバラけさせても結局共通化させなければならず、その際に出てくるのがcontextになる。</p><p name="3690" id="3690" class="graf graf--p graf-after--p">contextは救世主的に便利なのだが、Providerの指定漏れが起きることがあり悩ましいなーと感じた。Providerの設定を忘れるとcreateContext(defaultValue)で設定した値が来てしまうので結構気づかないことがある。contextがライブラリ向けのものという側面もあるので、そもそもProviderが無くて動くように出来てるのはそりゃーそうだよねという感じなのだが、stateと組み合わせるケースだと悩ましい。</p><p name="102e" id="102e" class="graf graf--p graf-after--p">対策としてReduxが内部で行ってるようにcreateContext(null)のような事をするという手もあるのだが、TypeScriptだとこれはこれで面倒というのがあってこれもこれで悩ましい。。。</p><p name="14a9" id="14a9" class="graf graf--p graf-after--p">useContextが複数絡み合うと「あ、これはやばいかもな」という気配は持ってしまうのでこの辺は少し考えないとだめかもしれない。</p><p name="27d6" id="27d6" class="graf graf--p graf-after--p">ひとまずの暫定対策としては、下記のようになるだろうか</p><ul class="postList"><li name="d6eb" id="d6eb" class="graf graf--li graf-after--p">ちょっと型付けが面倒でもdefaultValueはnullにしておく</li><li name="97a8" id="97a8" class="graf graf--li graf-after--li">複数のProviderはアプリケーションの上部でまとめて行う</li><li name="d70c" id="d70c" class="graf graf--li graf-after--li">絶対にProvider漏れを起こしたくない場合はFunction as Childrenの方を利用する</li><li name="d5bf" id="d5bf" class="graf graf--li graf-after--li">初期化されてる事を確認する<a href="https://gist.github.com/terrierscript/9680aabb749b17b9162af5e6df0b9566" data-href="https://gist.github.com/terrierscript/9680aabb749b17b9162af5e6df0b9566" class="markup--anchor markup--li-anchor" rel="nofollow noopener" target="_blank">safetyContext</a>みたいなものを自作する（考えてはみたけど、いやーこれも微妙だ・・・）</li><li name="85e6" id="85e6" class="graf graf--li graf-after--li"><a href="https://github.com/diegohaz/constate/blob/603cd7d3a40930dfa8991926783c5a5bc0b9e45b/src/index.tsx#L14-L16" data-href="https://github.com/diegohaz/constate/blob/603cd7d3a40930dfa8991926783c5a5bc0b9e45b/src/index.tsx#L14-L16" class="markup--anchor markup--li-anchor" rel="nofollow noopener" target="_blank">constateの内部実装</a>を見るとProxyを使って呼び出されたらエラーを吐くようにしていてなるほど〜という感じがある</li></ul><p name="969b" id="969b" class="graf graf--p graf-after--li">いずれにしてもちょっと微妙だ。もう少しこの辺は様子見してもいいかもしれない</p><p name="659b" id="659b" class="graf graf--p graf-after--p">あと、そもそも<a href="https://twitter.com/terrierscript/status/1093129622009434112" data-href="https://twitter.com/terrierscript/status/1093129622009434112" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">自分がContextをちゃんと理解してなかったなー</a>というのは色々いじってみて思った部分だった。結構ここは素振りしたほうが良い箇所かもしれない</p><h4 name="d4a3" id="d4a3" class="graf graf--h4 graf-after--p">useStateにfunctionを入れる時に気をつけよう</h4><div name="5712" id="5712" class="graf graf--mixtapeEmbed graf-after--h4"><a href="https://qiita.com/terrierscript/items/6a8acbc7d1ce6521f879" data-href="https://qiita.com/terrierscript/items/6a8acbc7d1ce6521f879" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://qiita.com/terrierscript/items/6a8acbc7d1ce6521f879"><strong class="markup--strong markup--mixtapeEmbed-strong">react-hooksのuseStateでfunctionを管理させたい場合のTips - Qiita</strong><br><em class="markup--em markup--mixtapeEmbed-em">react-hooksの`useState`はこれまでのstateのように値を保持してくれる重要な関数だ。 例えば単純なカウンターならこんな具合になるだろう ```jsx const useCounter = () =&gt; { ...</em>qiita.com</a><a href="https://qiita.com/terrierscript/items/6a8acbc7d1ce6521f879" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="89bb76daa0cdd79f65e0aa2911327507" data-thumbnail-img-id="0*nAleKpZwRIgskWDq" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*nAleKpZwRIgskWDq);"></a></div><p name="6616" id="6616" class="graf graf--p graf-after--mixtapeEmbed">こっちに書いたが結構ハマった。ちなみに今回のコードだと<a href="https://github.com/terrierscript/dartystrap/blob/2b5c0a2fc7bb0060b2290664384303bab802d94f/src/app/compiler/BootstrapCompiler.tsx#L53" data-href="https://github.com/terrierscript/dartystrap/blob/2b5c0a2fc7bb0060b2290664384303bab802d94f/src/app/compiler/BootstrapCompiler.tsx#L53" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">workerのterminate</a>を保持する場所でやってしまっていて「なーんでこれ止まってるんだ？」としばらく悩んでいた。</p><p name="dba9" id="dba9" class="graf graf--p graf-after--p">結果refを使ってstateに戻すことも出来たかがそのままにしている。実はあんまりこれまでrefsを使う事案に出会って無くてrefsをちゃんとわかってないので正しい使い方なのか微妙かもしれない</p><h4 name="c1c2" id="c1c2" class="graf graf--h4 graf-after--p">reduxのmiddlewareはどうなるだろう？という想像</h4><p name="9e3a" id="9e3a" class="graf graf--p graf-after--h4">今の所のstateを見るに、まだreduxを捨てるかどうかは微妙なとこかもなーと思いつつ、 middlewareはもうhooksに置き換えるだろうなーとは思った。個人的にはredux-observableが大好きで使っていたが、おそらく今後は出番が減るだろうなーとは感じている。</p><p name="af92" id="af92" class="graf graf--p graf-after--p">今までコンポーネントはActionを飛ばして、それをゴニョゴニョobservableでやるという部分が、componentで必要なときだけ<a href="https://github.com/LeetCode-OpenSource/rxjs-hooks" data-href="https://github.com/LeetCode-OpenSource/rxjs-hooks" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">rxjs-hooks</a>などでRxを使って処理するとかになっていくだろうなと感じる。ajaxの部分などはまた別にhooksが使えると思うので、Rx部分はよりそれ専門の部分だけになっていくだろうと感じる（でも、Rxの書き方や考え方は何も変わらないので、この点はやっぱり素敵を感じる）</p><h4 name="ef19" id="ef19" class="graf graf--h4 graf-after--p">createContextのimportに気をつけよう</h4><p name="39d0" id="39d0" class="graf graf--p graf-after--h4">よく見もせずにVSCodeのimportをしてると30分失うので気をつけたい</p><figure name="61e6" id="61e6" class="graf graf--figure graf--iframe graf-after--p graf--trailing"><blockquote class="twitter-tweet"><a href="https://twitter.com/terrierscript/status/1093114637082476544?s=20"></a></blockquote><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></figure></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@terrierscript" class="p-author h-card">terrierscript</a> on <a href="https://medium.com/p/7ef7ae7ca3fc"><time class="dt-published" datetime="2019-02-07T04:55:09.088Z">February 7, 2019</time></a>.</p><p><a href="https://medium.com/@terrierscript/functional-children%E6%8B%97%E3%82%89%E3%81%9B%E3%81%A6%E3%81%9F%E3%83%88%E3%82%A4%E3%83%97%E3%83%AD%E3%83%80%E3%82%AF%E3%83%88%E3%82%92react-hooks%E3%81%A8context%E4%BD%BF%E3%81%A3%E3%81%A6%E6%9B%B8%E3%81%8D%E6%8F%9B%E3%81%88%E3%81%9F%E6%84%9F%E6%83%B3-7ef7ae7ca3fc" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on June 1, 2019.</p></footer></article></body></html>